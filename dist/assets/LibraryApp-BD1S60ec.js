import{H as bt,R as X,M as W,C as st,L as rt,a as lt,D as ct,P as dt,G as Dt,b as xt,c as vt,d as St,V as kt,E as ft,S as Lt,e as Pt,f as Rt,g as Mt,h as Tt,W as Et,i as Bt,A as Yt,j as K,k as Ht,l as At,m as Ct,O as It,p as Ft,n as Wt,o as Q,q as tt,r as zt,s as Gt}from"./animation-B9tawhAX.js";import{l as Ot,g as _t}from"./index-DWYs1AIc.js";class Ut extends bt{constructor(e){console.warn("RGBELoader has been deprecated. Please use HDRLoader instead."),super(e)}}const f={shelfWidth:12,shelfDepth:4,shelfThickness:.15,levelHeight:4.5,bookHeight:3.5,gap:.05};function et(t){if(!t)return"";const e=new Date(t);return isNaN(e)?"":e.toLocaleDateString("en-US",{month:"short",year:"numeric"})}function $t(t,e,o,i){const a=(y,w,b)=>{const d=b.clone();return d.map&&(d.map=b.map.clone(),d.map.repeat.set(.2,.2),d.map.offset.set(Math.random(),Math.random()),d.map.center.set(.5,.5),d.map.rotation=Math.floor(Math.random()*4)*Math.PI/2),d},s=new X(f.shelfWidth+1,.2,f.shelfDepth+.2,4,.05),r=a(f.shelfWidth+1,f.shelfDepth+.2,i),l=new W(s,r);l.position.y=o+1,l.castShadow=!0,l.receiveShadow=!0,t.add(l);const c=new X(f.shelfWidth+1,.5,f.shelfDepth+.2,4,.05),n=new W(c,r);n.position.y=.5,n.receiveShadow=!0,t.add(n);for(let y=0;y<e;y++){const w=1+y*f.levelHeight,b=new X(f.shelfWidth,f.shelfThickness,f.shelfDepth,4,.075),d=a(f.shelfWidth,f.shelfDepth,i),v=new W(b,d);v.position.y=w,v.receiveShadow=!0,t.add(v)}}function Vt(t,e,o){if(!e||e.length===0)return;if(Array.isArray(e)===!1){if(e.type==="banner_top")Xt(t,o);else if(e.type==="banner_bottom"&&e.stats){const p=e.stats,T=p.minYear===p.maxYear?`${p.minYear}`:`${p.minYear} - ${p.maxYear}`;qt(t,o,p.count,T)}return}const i=e[0].shelf;let a="Read",s="date_read";i==="currently-reading"?(a="Currently Reading",s="date_added"):i==="to-read"&&(a="To Read",s="date_added");let r=e.map(p=>p[s]).filter(p=>p),l=a;if(r.length>0){r.sort();const p=et(r[0]),T=et(r[r.length-1]);p&&T&&(p===T?l+=` (${p})`:l+=` (${p} - ${T})`)}const c=document.createElement("canvas"),n=c.getContext("2d");c.width=1024,c.height=128;const y=800,w=100,b=(c.width-y)/2,d=(c.height-w)/2,v=20;n.fillStyle="rgba(15, 15, 20, 0.9)",n.strokeStyle="rgba(255, 255, 255, 0.2)",n.lineWidth=4,n.beginPath(),n.roundRect(b,d,y,w,v),n.fill(),n.stroke(),n.font='bold 40px "Outfit", sans-serif',n.textAlign="center",n.textBaseline="middle",n.fillStyle="#f0f0f0",n.shadowColor="rgba(0,0,0,0.8)",n.shadowBlur=4,n.shadowOffsetX=2,n.shadowOffsetY=2,n.fillText(l,c.width/2,c.height/2);const u=new st(c);u.minFilter=rt;const m=new lt({map:u,transparent:!0,side:ct}),g=new W(new dt(3,.4),m);g.position.y=o,g.position.z=f.shelfDepth/2+.02,g.scale.set(1,1,1),t.add(g)}function Xt(t,e,o,i,a){const s=document.createElement("canvas"),r=s.getContext("2d");s.width=1024,s.height=256;const l=800,c=150;(s.width-l)/2,(s.height-c)/2;const n="Vik's ",y="Library",w='600 160px "Cormorant Garamond", serif',b='400 160px "Dancing Script", cursive';r.textBaseline="middle",r.shadowColor="rgba(0,0,0,0.8)",r.shadowBlur=10,r.shadowOffsetX=2,r.shadowOffsetY=2,r.font=w;const d=r.measureText(n).width;r.font=b;const v=r.measureText(y).width,u=d+v;let m=(s.width-u)/2;const g=s.height/2;r.font=w,r.fillStyle="#ffffff",r.fillText(n,m,g),r.font=b,r.fillStyle="#d4a373",r.fillText(y,m+d,g),ut(t,s,e,12,3)}function qt(t,e,o,i){const a=document.createElement("canvas"),s=a.getContext("2d");a.width=1024,a.height=256;const r=900,l=150;(a.width-r)/2,(a.height-l)/2,s.textAlign="center",s.textBaseline="middle",s.fillStyle="#e0e0e0",s.shadowColor="rgba(0,0,0,0.8)",s.shadowBlur=4;const c=a.width/2,n=a.height/2;s.font='bold 80px "Outfit", sans-serif',s.fillText(`${o} Books  •  ${i}`,c,n),ut(t,a,e,12,3)}function ut(t,e,o,i,a){const s=new st(e);s.minFilter=rt;const r=new lt({map:s,transparent:!0,side:ct}),l=new W(new dt(i,a),r);l.position.y=o+f.shelfThickness/2+a/2,l.position.z=0,l.rotation.x=-Math.PI/12,t.add(l)}let Y,B=[],x=[],F={min:0,max:20};function Nt(t){Y&&D.remove(Y),Y=new Dt,D.add(Y);const e=new URLSearchParams(window.location.search),o=parseInt(e.get("per_shelf"))||10,i=new xt({color:16777215,metalness:.05,roughness:.02,transmission:.99,thickness:.5,clearcoat:1,ior:1.5,transparent:!0,opacity:1}),a=[];let s=[];const r=u=>u.shelf==="currently-reading"?"Reading":u.shelf==="to-read"?"To Read":"Read",l={count:t.length,minYear:"2020",maxYear:new Date().getFullYear()},c=t.map(u=>u.date_read||u.date_added).filter(u=>u);c.length>0&&(c.sort(),l.minYear=new Date(c[0]).getFullYear(),l.maxYear=new Date(c[c.length-1]).getFullYear()),t.forEach(u=>{if(s.length>=o&&(a.push(s),s=[]),s.length>0){const m=r(s[0]),g=r(u);m!==g&&(a.push(s),s=[],g==="Reading"?a.push({type:"banner_top"}):m==="Reading"?a.push({type:"banner_bottom",stats:l}):(m==="Reading"||g==="Reading")&&a.push([]))}s.push(u)}),s.length>0&&a.push(s);const n=a.length,y=Math.max(n*f.levelHeight,20),w=1,b=1+(n-1)*f.levelHeight;F.min=w-2,F.max=b+f.bookHeight+2,$t(Y,n,y,i);for(let u=0;u<n;u++){const m=1+u*f.levelHeight,g=n-1-u;a[g]&&Vt(Y,a[g],m)}x=[],B=[];let d=0,v=null;a.forEach((u,m)=>{let g=0;x[m]=[];let p=u;if(!Array.isArray(u))return;const T=[];p.forEach(G=>{const{mesh:C,thickness:k,height:O}=vt(G),P=f.bookHeight/O*(.95+Math.random()*.1);C.scale.set(P,P,P),C.rotation.y=Math.PI/2;const _=k*P;T.push({mesh:C,data:G,scaledThickness:_,rawHeight:O,scaleFactor:P}),g+=_}),g+=(p.length-1)*f.gap;let J=-g/2;T.forEach((G,C)=>{const{mesh:k,data:O,scaledThickness:P,rawHeight:_,scaleFactor:pt}=G;v===null&&O.shelf==="currently-reading"&&(v={row:m,col:C});const wt=J+P/2,mt=m,yt=1+(n-1-mt)*f.levelHeight+f.shelfThickness/2+_*pt/2;k.position.set(wt,yt,0),k.userData={...k.userData,id:d,originalRot:k.rotation.clone(),originalPos:k.position.clone(),originalScale:k.scale.clone(),gridPos:{row:m,col:C},scaledThickness:P},Y.add(k),B.push(k),x[m].push(k),J+=P+f.gap,d++})}),v?(V(v.row,v.col,!0),oe(f.levelHeight*.45)):x.length>0&&x[0].length>0&&V(0,0,!0)}let M=null,z=!1,nt=new St,q=new kt,h,S;function jt(t,e){h=t,S=e,window.addEventListener("resize",Jt),window.addEventListener("click",Qt),window.addEventListener("mousemove",Kt),window.addEventListener("wheel",Zt,{passive:!1}),e.addEventListener("change",N),N();const o=document.querySelector("#library-app .close-btn");o&&o.addEventListener("click",hideDetails)}function Zt(t){const e=document.getElementById("library-app");if(!e||e.classList.contains("hidden"))return;t.preventDefault();const o=t.deltaY*.01;if(h&&S){const i=h.position.y;let a=i-o;a=Math.max(F.min,Math.min(F.max,a));const s=a-i;Math.abs(s)>1e-4&&(h.position.y=a,S.target.y+=s)}}function Jt(){const t=document.getElementById("library-app");!t||t.classList.contains("hidden")||h&&(h.aspect=window.innerWidth/window.innerHeight,h.updateProjectionMatrix(),R.setSize(window.innerWidth,window.innerHeight))}function Kt(t){q.x=t.clientX/window.innerWidth*2-1,q.y=-(t.clientY/window.innerHeight)*2+1}function Qt(t){const e=document.getElementById("library-app");if(!e||e.classList.contains("hidden")||t.target.closest(".book-details")||t.target.closest(".nav-buttons")||!h)return;nt.setFromCamera(q,h);const o=nt.intersectObjects(B,!0);if(o.length>0){const i=o[0].object.parent;i&&i.userData&&i.userData.id!==void 0&&(M===i?ee():ht(i))}else Z()}function V(t,e,o=!1){if(!x[t])return;const i=x[t][e];if(i&&(ht(i),o&&h&&S)){const a=i.position.y;S.target.y=a,h.position.y=a}}function ht(t){if(M===t)return;M&&Z(),M=t;const e=t.userData.originalPos.clone();e.z+=4,e.y+=.5;const o=new ft(0,0,0),i=t.userData.originalScale.clone().multiplyScalar(1.3);if(t.userData.targetPos=e,t.userData.targetRot=o,t.userData.targetScale=i,t.userData.isAnimating=!0,t.userData.isSelected=!0,z=!1,te(t),t.userData){const a=new URL(window.location);a.searchParams.set("book",t.userData.id),window.history.replaceState(null,"",a),t.userData.title&&(document.title=`Vik's Books | ${t.userData.title}`)}}function te(t){t.userData&&typeof t.userData.loadTexture=="function"&&t.userData.loadTexture()}function Z(){if(window.coverLoadTimeout&&clearTimeout(window.coverLoadTimeout),!M)return;const t=M;t.userData.targetPos=t.userData.originalPos,t.userData.targetRot=t.userData.originalRot,t.userData.targetScale=t.userData.originalScale,t.userData.isAnimating=!0,t.userData.isSelected=!1,M=null;const e=new URL(window.location);e.searchParams.delete("book"),window.history.replaceState(null,"",e),document.title="Vik's Books",z=!1}function ee(){if(!M)return;z=!z;const t=M,e=new ft(0,z?Math.PI:0,0);t.userData.targetRot=e,t.userData.isAnimating=!0}function N(){if(!h)return;const t=h.position.y,e=3,o=Math.abs(t-F.max)<e,i=Math.abs(t-F.min)<e,a=document.querySelector("#library-app .header");a&&(o||i?a.classList.remove("hidden"):a.classList.add("hidden")),ne()}function ne(){if(!h||!x||x.length===0)return;const t=h.position.y,e=15;x.forEach(o=>{if(!o||o.length===0)return;const i=o[0].position.y;Math.abs(i-t)<e&&o[o.length-1]})}let U=0;function $(t){if(!x||x.length===0||!h||!S)return;let e=U+t;if(e=Math.max(0,Math.min(e,x.length-1)),e===U)return;U=e;const o=x[U];if(o&&o.length>0){const i=o[0].position.y;h.position.y,S.target.y,ae(i)}}function ae(t,e){const o=S.target.y,i=t-o,a=performance.now(),s=500;function r(l){const c=l-a,n=Math.min(1,c/s),y=n*(2-n),w=o+i*y;S.target.y=w,h.position.y=w+5,n<1?requestAnimationFrame(r):(S.target.y=t,h.position.y=t+5,N())}requestAnimationFrame(r)}function oe(t){h&&S&&(h.position.y+=t,S.target.y+=t)}let D,E,R,L,gt,I=!1,at=!1,ot=new Wt,H=[];const A={ArrowLeft:!1,ArrowRight:!1};function de(){if(I){it();return}I=!0;const t=document.getElementById("library-app");if(t&&t.innerHTML.trim()===""&&(t.innerHTML=ie()),t&&t.classList.remove("hidden"),at){j(),it();return}const e=document.getElementById("library-canvas-container");if(!e){console.error("Library container not found");return}D=new Lt,D.background=new Pt("#111111"),Rt(D),Mt(D),E=new Tt(45,window.innerWidth/window.innerHeight,.1,1e3),E.position.set(0,5,12),R=new Et({antialias:!0}),R.setPixelRatio(window.devicePixelRatio),R.setSize(window.innerWidth,window.innerHeight),R.shadowMap.enabled=!0,R.shadowMap.type=Bt,e.appendChild(R.domElement);const o=new Yt(16777215,.6);D.add(o);const i=new K(16772560,1.2);i.position.set(5,10,10),i.castShadow=!0,i.shadow.mapSize.width=2048,i.shadow.mapSize.height=2048,D.add(i);const a=new K(11591910,.5);a.position.set(-5,5,10),D.add(a);const s=new Ht(13935475,2);s.position.set(-5,8,5),s.angle=Math.PI/4,s.penumbra=.5,D.add(s);const r=new At(16755200,1,20);r.position.set(0,5,12),D.add(r),new Ut().setPath("").load("environment.hdr",function(n){n.mapping=Ct,D.environment=n,D.environmentIntensity=1},void 0,function(n){console.warn("HDR not found.")}),L=new It(E,R.domElement),L.enableDamping=!0,L.dampingFactor=.05,L.enableRotate=!1,L.enableZoom=!1,L.target.set(0,0,0),jt(E,L),Ft().then(()=>{Ot().then(n=>{H=_t(n),Nt(H);const w=new URLSearchParams(window.location.search).get("book");if(w&&H.length>0){const b=H.findIndex(d=>d.id===w);if(b!==-1&&B[b]){const d=B[b];d.userData&&d.userData.gridPos&&setTimeout(()=>{V(d.userData.gridPos.row,d.userData.gridPos.col,!0)},100)}}})}),window.addEventListener("keydown",n=>{I&&(n.key==="ArrowUp"?$(-1):n.key==="ArrowDown"&&$(1),A.hasOwnProperty(n.key)&&(A[n.key]=!0))}),window.addEventListener("keyup",n=>{I&&A.hasOwnProperty(n.key)&&(A[n.key]=!1)});const l=document.getElementById("nav-up"),c=document.getElementById("nav-down");l&&l.addEventListener("click",n=>{n.stopPropagation(),$(-1)}),c&&c.addEventListener("click",n=>{n.stopPropagation(),$(1)}),at=!0,j()}function fe(){I=!1,cancelAnimationFrame(gt);const t=document.getElementById("library-app");t&&t.classList.add("hidden")}function j(){if(!I)return;gt=requestAnimationFrame(j);const t=ot.getElapsedTime();if(typeof Q=="function"&&Q(t,0),typeof tt=="function"&&tt(E),L.update(),A.ArrowLeft||A.ArrowRight){const e=E.position.clone().sub(L.target),o=(A.ArrowLeft?-1:1)*.02;e.applyAxisAngle(new zt(0,1,0),o),E.position.copy(L.target).add(e)}B.forEach(e=>{if(e.userData.isAnimating&&e.userData.targetPos)e.position.lerp(e.userData.targetPos,.1),e.userData.targetScale&&e.scale.lerp(e.userData.targetScale,.1),e.rotation.x+=(e.userData.targetRot.x-e.rotation.x)*.1,e.rotation.y+=(e.userData.targetRot.y-e.rotation.y)*.1,e.rotation.z+=(e.userData.targetRot.z-e.rotation.z)*.1,e.position.distanceTo(e.userData.targetPos)<.01&&(e.userData.isAnimating=!1);else if(e.userData.isSelected){const o=ot.getElapsedTime();Gt(e,o)}}),R.render(D,E)}function ie(){return`
        <div class="header hidden">
            <h1 class="title">Vik's <span class="accent">Library</span></h1>
        </div>
        
        <!-- Navigation Controls -->
        <div class="nav-buttons">
            <button id="nav-up" class="nav-btn" aria-label="Previous Shelf">
                ▲
            </button>
            <button id="nav-down" class="nav-btn" aria-label="Next Shelf">
                ▼
            </button>
        </div>

        <div id="library-canvas-container"></div>
    `}function it(){const e=new URLSearchParams(window.location.search).get("book");if(e&&H&&H.length>0){const o=H.findIndex(i=>i.id===e);if(o!==-1&&B[o]){const i=B[o];i.userData&&i.userData.gridPos&&V(i.userData.gridPos.row,i.userData.gridPos.col,!0)}}else Z()}export{E as camera,L as controls,de as initLibrary,R as renderer,D as scene,fe as stopLibrary};
